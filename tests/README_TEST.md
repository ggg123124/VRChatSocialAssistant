# VRChat 社交辅助工具 - 集成测试使用指南

## 概述

本集成测试工具提供了一个命令行交互式界面，用于测试 VRChat 社交辅助工具的各个模块功能，包括：

- 🎤 **音频采集** - 测试音频设备和采集功能
- 🗣️ **VAD 检测** - 测试语音活动检测
- 👤 **说话人识别** - 测试声纹注册和识别
- 📝 **语音转文本** - 测试 STT 功能
- 🧠 **记忆管理** - 测试档案管理和语义检索
- 🔗 **完整流程** - 测试端到端的语音处理流程

## 快速开始

### 1. 环境准备

确保已安装所有依赖：

```bash
pip install -r requirements.txt
```

### 2. 启动测试程序

```bash
# 正常启动（交互式菜单）
python tests/integrated_test.py

# 仅运行初始化检查
python tests/integrated_test.py --init

# 直接运行完整流程测试
python tests/integrated_test.py --full

# 启用调试模式
python tests/integrated_test.py --debug
```

### 3. 首次使用

首次运行时，建议按以下步骤操作：

1. **系统初始化** - 选择菜单选项 [1]，检查环境并初始化所有模块
2. **单模块测试** - 选择菜单选项 [2]，逐个测试各模块功能
3. **完整流程测试** - 选择菜单选项 [3]，测试端到端流程

## 功能详解

### 主菜单

```
[1] 系统初始化 - 检查环境并初始化所有模块
[2] 单模块测试 - 测试各个模块的独立功能
[3] 完整流程测试 - 运行端到端的语音处理流程
[4] 数据管理 - 管理好友档案和对话记录
[5] 系统信息 - 查看系统状态和统计信息
[0] 退出系统
```

### 1. 系统初始化

系统初始化会执行以下检查：

- ✓ 检查配置文件是否存在
- ✓ 检查并创建必要的数据目录
- ✓ 初始化所有模块（音频、VAD、说话人识别、STT、记忆管理）
- ✓ 显示初始化结果

**注意事项：**
- 首次运行会自动下载所需的模型文件（VAD、STT、声纹识别、文本嵌入）
- 模型文件较大（总计约 3-5GB），需要确保网络连接稳定
- 模型会自动保存到 `models/` 目录，下次运行无需重新下载

### 2. 单模块测试

#### 2.1 音频采集测试

测试内容：
- **设备枚举** - 列出所有可用的音频设备
- **短时采集** - 采集 5 秒音频并显示统计信息

适用场景：
- 检查系统音频设备是否正常
- 验证 WASAPI Loopback 功能
- 测试音频采集性能

#### 2.2 VAD 检测测试

测试内容：
- 使用合成音频序列（静音-语音-静音-语音-静音）
- 检测语音片段
- 显示检测结果和性能统计

验证指标：
- 语音片段检测数量
- 检测置信度
- 处理延迟（目标 < 30ms）
- 丢帧率（目标 0%）

#### 2.3 说话人识别测试

测试内容：
- **注册好友** - 注册新的声纹档案
- **识别测试** - 测试声纹识别准确率
- **查看列表** - 显示已注册的好友

操作流程：
1. 选择"注册新好友"
2. 输入好友姓名
3. 系统自动生成声纹样本（实际使用时应采集真实人声）
4. 完成注册后可进行识别测试

**注意：** 演示使用合成音频，实际使用时应采集真实人声录音（每人 3 段，每段 2-3 秒）

#### 2.4 STT 测试

测试内容：
- 使用合成音频进行识别
- 显示识别结果（文本、置信度、语言、引擎类型）
- 显示处理时间

**注意：** 合成音频可能无法被正确识别（这是正常的），主要测试模块是否正常工作。

#### 2.5 记忆管理测试

测试内容：
- **创建档案** - 创建好友档案（姓名、偏好、性格等）
- **添加对话** - 添加对话记录
- **检索记忆** - 语义检索相关对话
- **查看统计** - 显示数据统计

操作流程：
1. 创建好友档案
2. 添加若干条对话记录
3. 使用关键词检索相关对话
4. 查看检索结果和相似度分数

### 3. 完整流程测试

端到端测试整个语音处理流程：

```
音频采集 → VAD 检测 → 说话人识别 → STT → 记忆存储 → 记忆检索
```

**前置条件：**
- 所有模块必须已初始化成功
- 建议先完成单模块测试

**测试步骤：**
1. 生成测试音频
2. VAD 检测语音片段
3. 识别说话人
4. 语音转文本
5. 存储对话记录
6. 检索相关记忆
7. 显示完整结果

### 4. 数据管理

管理系统中的数据：

- **好友管理** - 查看、添加、删除好友档案
- **对话记录** - 查看历史对话记录
- **数据统计** - 显示存储空间、记录数量等
- **数据清理** - 清理过期或无用数据

### 5. 系统信息

显示系统状态：

- 各模块的初始化状态
- Python 版本信息
- 项目路径、配置路径、数据路径
- 环境信息

## 测试数据

项目提供了示例测试数据，位于 `tests/test_data/` 目录：

### 示例好友档案 (`sample_profiles.json`)

包含 3 个示例好友档案：
- 测试好友A - 喜欢游戏、动漫、VRChat
- 测试好友B - 喜欢音乐、摄影、旅行
- 测试好友C - 喜欢编程、科技、电影

### 示例对话记录 (`sample_conversations.json`)

包含 7 条示例对话记录，可用于测试记忆检索功能。

## 常见问题

### Q1: 初始化失败怎么办？

**A:** 检查以下几点：
- 确保已安装所有依赖：`pip install -r requirements.txt`
- 检查网络连接（首次运行需要下载模型）
- 查看日志文件：`tests/integrated_test.log`
- 尝试单独测试各模块，定位具体问题

### Q2: 音频采集失败？

**A:** 可能的原因：
- Windows 10/11 系统需要 WASAPI 支持
- 音频设备未正确安装或启用
- 尝试运行 `python tests/list_devices.py` 查看可用设备

### Q3: VAD 检测不到语音？

**A:** 调整参数：
- 降低检测阈值（默认 0.5）
- 减小最小语音时长（默认 250ms）
- 确保音频包含足够的能量（不是纯静音）

### Q4: 说话人识别不准确？

**A:** 注意事项：
- 测试时使用合成音频，准确率有限
- 实际使用应采集真实人声（每人 3 段，每段 2-3 秒）
- 确保录音环境安静，音质清晰
- 可调整相似度阈值

### Q5: STT 识别失败？

**A:** 检查项：
- 首次运行会下载 Whisper 模型，需要时间
- 合成音频可能无法识别（正常现象）
- 使用真实语音进行测试
- 检查是否有可用的 STT 引擎（本地/云端）

### Q6: 记忆检索没有结果？

**A:** 确认：
- 是否已添加对话记录
- 查询关键词是否相关
- 嵌入模型是否正确加载
- 查看 `data/` 目录是否有数据文件

### Q7: 模型下载太慢？

**A:** 解决方案：
- 使用国内镜像源（配置文件中设置 `download_mirror: "modelscope"`）
- 手动下载模型文件到对应目录
- 使用代理加速下载

### Q8: 如何重置系统？

**A:** 
1. 删除 `data/` 目录下的所有文件
2. 删除 `models/` 目录（如需重新下载模型）
3. 重新运行系统初始化

## 日志和调试

### 日志文件

测试运行时会生成日志文件：`tests/integrated_test.log`

日志包含：
- 模块初始化信息
- 操作执行记录
- 错误和异常详情
- 性能统计数据

### 调试模式

启用调试模式以获取更详细的日志：

```bash
python tests/integrated_test.py --debug
```

调试模式会显示：
- 详细的函数调用信息
- 数据处理过程
- 模型加载细节
- 更多的性能指标

## 性能基准

各模块的参考性能指标：

| 模块 | 指标 | 目标值 | 说明 |
|------|------|--------|------|
| 音频采集 | 丢帧率 | 0% | 无溢出、无丢帧 |
| VAD | 处理延迟 | < 30ms | 平均每帧处理时间 |
| 说话人识别 | 识别时间 | < 500ms | 包含特征提取和匹配 |
| STT | RTF | < 0.5 | 实时因子，越小越快 |
| 记忆检索 | 检索时间 | < 200ms | 语义检索延迟 |

## 扩展和定制

### 自定义配置

可通过修改 `config/` 目录下的配置文件自定义参数：

- `audio_config.yaml` - 音频采集和 VAD 参数
- `speaker_recognition_config.yaml` - 说话人识别参数
- `stt_config.yaml` - STT 引擎参数
- `memory_config.yaml` - 记忆管理参数

### 添加测试用例

可在 `tests/test_data/` 目录添加自定义测试数据：

- 音频文件（WAV 格式，16kHz，单声道）
- 好友档案 JSON
- 对话记录 JSON

### 集成到 CI/CD

可使用命令行参数进行自动化测试：

```bash
# 自动化测试脚本示例
python tests/integrated_test.py --init && \
python tests/integrated_test.py --module vad && \
python tests/integrated_test.py --full
```

## 技术支持

遇到问题时：

1. 查看本文档的"常见问题"部分
2. 检查日志文件：`tests/integrated_test.log`
3. 查看项目 README.md
4. 提交 Issue 到项目仓库

## 版本历史

### v1.0.0 (2025-11-25)

初始版本，包含以下功能：

- ✅ 系统初始化和环境检查
- ✅ 音频采集测试
- ✅ VAD 检测测试
- ✅ 说话人识别测试
- ✅ STT 测试
- ✅ 记忆管理测试
- ✅ 数据管理功能
- ✅ 系统信息显示
- ⏳ 完整流程测试（部分功能）

## 致谢

感谢以下开源项目：

- Silero VAD
- pyaudiowpatch
- faster-whisper
- pyannote.audio
- ChromaDB
- BGE-M3

---

**注意：** 本测试工具仍在积极开发中，功能可能会持续更新。
